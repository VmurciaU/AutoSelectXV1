{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white py-20 px-8">
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">

    <!-- Secci√≥n de descripci√≥n -->
    <div class="md:col-span-2 space-y-6">
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-teal-300">Acerca de AutoSelect-X</h2>
          {% if selected_case_id %}
            <span class="text-xs bg-gray-700 px-2 py-1 rounded">
              Caso activo: #{{ selected_case_id }}
            </span>
          {% endif %}
        </div>
        <p class="text-sm text-gray-300 mt-2">
          Esta aplicaci√≥n inteligente te permite cargar documentos t√©cnicos (Hojas de Datos y Manuales de Requisitos)
          para extraer autom√°ticamente informaci√≥n clave. Sube tus archivos PDF y luego podr√°s realizar b√∫squedas
          y consultas sobre los requisitos t√©cnicos directamente.
        </p>
      </div>

      <!-- Instrucciones -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h3 class="text-lg font-semibold text-teal-300 mb-2">Instrucciones</h3>
        <p class="text-sm text-gray-300 mb-2">
          Bienvenido a la secci√≥n de carga de documentos. Por favor, sube los archivos PDF correspondientes a HD o MR.
        </p>
        <ul class="text-sm text-gray-400 list-disc list-inside">
          <li><strong>Tipos de archivos aceptados:</strong> .pdf</li>
          <li><strong>Consideraciones:</strong> Aseg√∫rate de que los documentos sean legibles y est√©n en formato est√°ndar.</li>
        </ul>
      </div>

      <!-- Formulario de carga -->
      <form method="POST" action="/upload" enctype="multipart/form-data" class="space-y-4">
        <!-- MUY IMPORTANTE: mantener el caso activo -->
        <input type="hidden" name="case_id" value="{{ selected_case_id }}">
        <div>
          <label for="file" class="block text-sm font-medium mb-1">Seleccionar documento</label>
          <input
            type="file" id="file" name="file" accept=".pdf"
            class="bg-gray-700 text-white w-full border border-gray-600 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
        </div>
        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded transition">
          Cargar Documento
        </button>
      </form>

      <!-- Bot√≥n de procesamiento -->
      <form method="POST" action="/procesar" class="mt-2">
        <button type="submit"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-6 py-2 rounded transition mt-4">
          Procesar Documentos
        </button>
      </form>

      <!-- Barra de progreso din√°mica -->
      {% if processing_status == 'in_progress' %}
      <div class="mt-6">
        <div class="text-sm font-medium text-white mb-2">Estado del procesamiento</div>
        <div class="w-full bg-gray-700 rounded-full h-4">
          <div id="barra-progreso" class="bg-yellow-400 h-4 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
        </div>
        <p id="mensaje-progreso" class="text-xs mt-2 text-gray-300">
          ‚è≥ Procesando documentos, por favor espera...
        </p>
      </div>

      <script>
        function actualizarProgreso() {
          fetch('/progress')
            .then(res => res.json())
            .then(data => {
              // Backend puede devolver {progress: 0} o {progress:{percent:<num>}}
              let progreso = 0;
              if (data && typeof data.progress === 'number') {
                progreso = data.progress;
              } else if (data && data.progress && typeof data.progress.percent === 'number') {
                progreso = data.progress.percent;
              }

              const barra = document.getElementById('barra-progreso');
              const mensaje = document.getElementById('mensaje-progreso');

              barra.style.width = progreso + '%';

              if (progreso >= 100) {
                mensaje.textContent = '‚úÖ Procesamiento completado. Redirigiendo...';
                setTimeout(() => {
                  window.location.href = '/upload?processing_status=done{% if selected_case_id %}&selected_case_id={{ selected_case_id }}{% endif %}';
                }, 1500);
              } else {
                setTimeout(actualizarProgreso, 1000);
              }
            })
            .catch(() => {
              setTimeout(actualizarProgreso, 2000); // reintenta tras error
            });
        }

        window.addEventListener('load', actualizarProgreso);
      </script>

      {% elif processing_status == 'done' %}
      <div class="mt-6">
        <div class="text-sm font-medium text-white mb-2">Estado del procesamiento</div>
        <div class="w-full bg-gray-700 rounded-full h-4">
          <div class="bg-green-500 h-4 rounded-full w-full"></div>
        </div>
        <p class="text-xs mt-2 text-gray-300">
          ‚úÖ Procesamiento completado. Puedes continuar con las b√∫squedas.
        </p>
      </div>
      {% endif %}

      <!-- Bot√≥n buscar -->
      <form action="/buscar" method="GET">
        <button type="submit"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold px-6 py-2 rounded transition mt-6">
          Buscar
        </button>
      </form>
    </div>

    <!-- Lista de archivos subidos (desde DB) -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-md w-full max-w-lg">
      <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
        üìÑ Documentos Cargados
      </h3>
      <hr class="border-gray-600 mb-4">

      {% if docs and docs|length > 0 %}
      <ul class="space-y-2">
        {% for d in docs %}
        <li class="bg-gray-700 px-3 py-2 rounded text-gray-200 text-sm">
          <div class="flex justify-between items-start gap-3">
            <div class="w-4/5">
              <div class="font-medium break-words">{{ d.filename }}</div>
              <div class="text-xs text-gray-400 mt-1">
                {% if d.pages %}{{ d.pages }} p√°g.{% else %}p√°g. n/d{% endif %}
                ¬∑
                {% if d.size_bytes %}
                  {{ (d.size_bytes / 1024)|round(1) }} KB
                {% else %}
                  tama√±o n/d
                {% endif %}
                ¬∑
                {% if d.created_at %}
                  {{ d.created_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  fecha n/d
                {% endif %}
              </div>
            </div>

            <form method="POST" action="/delete-file" class="ml-2">
              <!-- Mantener el caso activo al eliminar -->
              <input type="hidden" name="case_id" value="{{ selected_case_id }}">
              <input type="hidden" name="doc_id" value="{{ d.id }}">
              <button type="submit"
                      class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-2 py-1 rounded transition">
                Eliminar
              </button>
            </form>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-sm text-gray-400">No se han subido archivos a√∫n.</p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
